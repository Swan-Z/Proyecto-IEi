<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de centros educativos</title>

    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <style>
        .map {
            height: 400px;
            width: 100%;
        }
    </style>

</head>
<body>

<h1>Buscador de centros educativos</h1>

<div>
    <label for="localidad" style="margin-left: 27px;">Localidad:</label>
    <input type="text" id="localidad" style="width: 300px;" />
</div>

<div style="margin-top: 10px;">
    <label for="codigoPostal">Código Postal:</label>
    <input type="text" id="codigoPostal" style="width: 300px;" />
</div>

<div style="margin-top: 10px;">
    <label for="provincia" style="margin-left: 28px;">Provincia:</label>
    <input type="text" id="provincia" style="width: 300px;" />
</div>

<div style="margin-top: 10px;">
    <label for="tipo" style="margin-left: 60px;">Tipo:</label>
    <select id="tipo">
        <option value="Público">Público</option>
        <option value="Privado">Privado</option>
        <option value="Concertado">Concertado</option>
        <option value="Otro">Otro</option>
    </select>
</div>

<div id="fuente" style="margin-top: 10px;" ></div>



<div style="margin-top: 30px; margin-left: 235px;">
    <button onclick="cancelar()" style="margin-right: 40px;">Cancelar</button>
    <button onclick="buscar()">Buscar</button>
</div>

<div id="map" style="width: 100%; height: 400px; margin-top: 20px;"></div>

<div id="error" style="margin-top: 10px;"></div>

<div id="sinResultados" style="display: none; color: red; font-size: 18px; text-align: center; margin-top: 20px;">
    No se ha encontrado ningún centro educativo.
</div>

<script>
    function obtenerValores() {
        const localidad = document.getElementById("localidad").value;
        const codigoPostal = document.getElementById("codigoPostal").value;
        const provincia = document.getElementById("provincia").value;
        const tipo = document.getElementById("tipo").value;

        return { localidad, codigoPostal, provincia, tipo };
    }

    function cancelar() {
        document.getElementById("localidad").value = "";
        document.getElementById("codigoPostal").value = "";
        document.getElementById("provincia").value = "";
        document.getElementById("tipo").value = "";
        document.getElementById('fuente').innerHTML = "";
        document.getElementById('sinResultados').style.display = 'none';
    }

    async function buscar() {
        try {
            const { localidad, codigoPostal, provincia, tipo } = obtenerValores();

            // Verificar si hay datos antes de continuar
            if (localidad === "" && codigoPostal === "" && provincia === "" && tipo === "") {
                document.getElementById('sinResultados').style.display = 'block';
            } else {
                document.getElementById('sinResultados').style.display = 'none';
            }

            // Enviar los datos al backend
            const url = `http://localhost:8000/busqueda/${localidad}/${provincia}/${codigoPostal}/${tipo}`;
            const response = await fetch(url, { method: 'GET' });

            // Verificar si la respuesta es correcta
            if (!response.ok) {
                console.error('Error al cargar datos desde el backend:', response);
                document.getElementById('sinResultados').style.display = 'block';
                return;
            } else {
                document.getElementById('sinResultados').style.display = 'none';
            }

            const datos = await response.json(); // Parsear la respuesta como JSON
            console.log('Datos recibidos:', datos);
            
            //ACTUALIZACION DE MAPA
            const primerItem = datos[0];
            actualizarMapa(primerItem.latitud, primerItem.longitud);
            console.log('Primer item:', primerItem.latitud, primerItem.longitud);
            

            const tablaHTML = `<div style="max-width: auto; margin: 0 auto; font-size: 16px;">
                            <table style="border-collapse: collapse; width: 100%; border: 1px solid #dddddd;">
                                <thead>
                                    <tr>
                                        <th style="border: 1px solid #dddddd; text-align: left; padding: 8px;">Nombre</th>
                                        <th style="border: 1px solid #dddddd; text-align: left; padding: 8px;">Tipo</th>
                                        <th style="border: 1px solid #dddddd; text-align: left; padding: 8px;">Dirección</th>
                                        <th style="border: 1px solid #dddddd; text-align: left; padding: 8px;">Localidad</th>
                                        <th style="border: 1px solid #dddddd; text-align: left; padding: 8px;">Cód.Postal</th>
                                        <th style="border: 1px solid #dddddd; text-align: left; padding: 8px;">Provincia</th>
                                        <th style="border: 1px solid #dddddd; text-align: left; padding: 8px;">Descripción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${datos.map(item =>
                    `<tr><td style="border: 1px solid #dddddd; text-align: left; padding: 8px;">${item.nombre}
                                        </td><td style="border: 1px solid #dddddd; text-align: left; padding: 8px;">${item.tipo}
                                        </td><td style="border: 1px solid #dddddd; text-align: left; padding: 8px;">${item.direccion}
                                        </td><td style="border: 1px solid #dddddd; text-align: left; padding: 8px;">${document.getElementById("localidad").value}
                                        </td><td style="border: 1px solid #dddddd; text-align: left; padding: 8px;">${item.codigo_postal}
                                        </td><td style="border: 1px solid #dddddd; text-align: left; padding: 8px;">${document.getElementById("provincia").value}
                                        </td><td style="border: 1px solid #dddddd; text-align: left; padding: 8px;">${item.descripcion}
                                        </td></tr>`).join('')}
                                </tbody>
                            </table>
                        </div>`;

            // Cambiar el contenido HTML del elemento con id "fuente"
            document.getElementById('fuente').innerHTML = tablaHTML;
        } catch (error) {
            console.error('Error al cargar datos desde el backend:', error);
        }
    }

    function actualizarMapa(latitud, longitud) {
            const coordenadas = [parseFloat(longitud), parseFloat(latitud)];
            map.getView().setCenter(ol.proj.fromLonLat(coordenadas));

            // Modificar el estilo del marcador
            const markerStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    src: 'https://openlayers.org/en/latest/examples/data/icon.png', // Puedes cambiar la URL de la imagen del marcador
                    scale: 1, // Ajusta la escala del marcador según tu preferencia
                }),
            });

            // AGREGAR MARCADOR AL MAPA CON EL NUEVO ESTILO
            const marker = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat(coordenadas)),
            });

            marker.setStyle(markerStyle);

            const markerSource = new ol.source.Vector({
                features: [marker],
            });

            const markerLayer = new ol.layer.Vector({
                source: markerSource,
            });

            map.addLayer(markerLayer);
        }
    var map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([-3.70256,40.4165]), 
            zoom: 12
        })
    });

</script>

</body>
</html>